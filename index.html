<!DOCTYPE html>
<html>
<head>
    <title>Mediterranee Imobiliaria - Mapa de Lotes</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
        }
        #sidebar {
            width: 25%;
            padding: 20px;
            background-color: #f5f5f5;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #map {
            width: 75%;
            height: 100%;
        }
        textarea, input, select, button {
            width: 100%;
            margin-bottom: 10px;
        }
        #infoLote {
            border: 1px solid #ccc;
            background-color: #fff;
            padding: 10px;
            margin-bottom: 10px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        button {
            padding: 8px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        @media (max-width: 600px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: auto; }
            #map { width: 100%; height: 60vh; }
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h1>Mediterranee Imobiliaria</h1>

    <label for="loteSelect">Selecione um lote:</label>
    <select id="loteSelect" onchange="destacarLote()">
        <option value="">-- Escolha um lote --</option>
    </select>
    <button onclick="excluirLote()">Excluir Lote Selecionado</button>
    <button onclick="editarLote()">Editar Lote Selecionado</button>

    <div id="infoLote">
        <h3>Descrição do lote:</h3>
        <div id="dadosLote">Nenhum lote selecionado.</div>
    </div>

    <h3>Cadastrar / Editar lote:</h3>
    <input type="text" id="nomeLote" placeholder="Nome do lote">
    <textarea id="descricaoLote" rows="3" placeholder="Descrição..."></textarea>
    <textarea id="coordenadas" rows="4" placeholder="Coordenadas lat,lon por linha..."></textarea>
    <button onclick="adicionarOuAtualizarLote()">Salvar Lote</button>
    <button onclick="modoDesenho()">Desenhar Lote no Mapa</button>
    <button id="cancelarDesenhoBtn" onclick="cancelarDesenho()" style="display:none;">Cancelar Desenho</button>
</div>

<div id="map"></div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbylJLajX7UMAcjQTt_4A2eoDqILCKLHCSDNXmeDh9R07xQqdREL0b1b0NHXJSoNM0hM/exec';
    let map;
    const lotes = {};
    const poligonos = {};
    let loteEditando = null;
    let drawingMode = false;
    let tempCoords = [];
    let tempPolyline = null;
    let distanceOverlays = [];
    let hoverInfo = null;
    let hoverLine = null;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: -20.899359547695433, lng: -46.99020733379837 },
            zoom: 18,
            mapTypeId: 'satellite'
        });

        fetch(API_URL)
          .then(response => response.json())
          .then(data => {
              data.forEach(lote => {
                  try {
                      lotes[lote.id] = {
                          nome: lote.nome,
                          descricao: lote.descricao,
                          area: JSON.parse(lote.coordenadas)
                      };
                      adicionarPoligonoAoMapa(lote.id, lotes[lote.id]);
                      adicionarLoteAoDropdown(lote.id, lotes[lote.id]);
                  } catch (e) {
                      console.error('Erro ao processar lote:', lote, e);
                  }
              });
          });

        map.addListener("click", (e) => {
            if (drawingMode) {
                const point = { lat: e.latLng.lat(), lng: e.latLng.lng() };
                tempCoords.push(point);
                if (tempPolyline) tempPolyline.setMap(null);
                tempPolyline = new google.maps.Polyline({
                    path: tempCoords,
                    map: map,
                    strokeColor: "#FF0000",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    clickable: false,
                });
                if (tempCoords.length > 1) {
                    const prev = tempCoords[tempCoords.length - 2];
                    const start = new google.maps.LatLng(prev);
                    const end = new google.maps.LatLng(point);
                    const dist = google.maps.geometry.spherical.computeDistanceBetween(start, end);
                    const mid = new google.maps.LatLng((prev.lat + point.lat) / 2, (prev.lng + point.lng) / 2);
                    const info = new google.maps.InfoWindow({ content: dist.toFixed(2) + ' m', position: mid });
                    info.open(map);
                    distanceOverlays.push(info);
                }
                if (hoverInfo) hoverInfo.close();
                if (hoverLine) hoverLine.setMap(null);
            }
        });

        map.addListener("mousemove", (e) => {
            if (drawingMode && tempCoords.length > 0) {
                const last = tempCoords[tempCoords.length - 1];
                const start = new google.maps.LatLng(last);
                const dist = google.maps.geometry.spherical.computeDistanceBetween(start, e.latLng);
                const mid = new google.maps.LatLng((last.lat + e.latLng.lat()) / 2,
                                                (last.lng + e.latLng.lng()) / 2);
                if (!hoverInfo) hoverInfo = new google.maps.InfoWindow();
                hoverInfo.setContent(dist.toFixed(2) + ' m');
                hoverInfo.setPosition(mid);
                hoverInfo.open(map);
                if (hoverLine) hoverLine.setMap(null);
                hoverLine = new google.maps.Polyline({
                    path: [last, { lat: e.latLng.lat(), lng: e.latLng.lng() }],
                    map: map,
                    strokeColor: "#FF0000",
                    strokeOpacity: 0.5,
                    strokeWeight: 2,
                    clickable: false,
                });
            } else {
                if (hoverInfo) hoverInfo.close();
                if (hoverLine) hoverLine.setMap(null);
            }
        });
    }

    function modoDesenho() {
        drawingMode = true;
        tempCoords = [];
        if (tempPolyline) tempPolyline.setMap(null);
        distanceOverlays.forEach(o => o.close());
        distanceOverlays = [];
        if (hoverInfo) hoverInfo.close();
        if (hoverLine) hoverLine.setMap(null);
        if (map) map.setOptions({ draggableCursor: 'default', draggingCursor: 'default' });
        document.getElementById('cancelarDesenhoBtn').style.display = 'block';
        alert("Modo desenho ativado: clique no mapa para marcar os pontos do lote. Depois clique em 'Salvar Lote'.");
    }

    function cancelarDesenho() {
        drawingMode = false;
        tempCoords = [];
        if (map) map.setOptions({ draggableCursor: null, draggingCursor: null });
        if (tempPolyline) tempPolyline.setMap(null);
        distanceOverlays.forEach(o => o.close());
        distanceOverlays = [];
        if (hoverInfo) hoverInfo.close();
        if (hoverLine) hoverLine.setMap(null);
        document.getElementById('cancelarDesenhoBtn').style.display = 'none';
    }

    function adicionarPoligonoAoMapa(key, lote) {
        if (poligonos[key]) poligonos[key].setMap(null);
        const polygon = new google.maps.Polygon({
            paths: lote.area,
            strokeColor: "#00FF00",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#00FF00",
            fillOpacity: 0.35,
            map: map,
        });
        polygon.addListener("click", () => mostrarInfoLote(key));
        poligonos[key] = polygon;
    }

    function adicionarLoteAoDropdown(key, lote) {
        const select = document.getElementById('loteSelect');
        if (!document.querySelector(`option[value='${key}']`)) {
            const option = document.createElement('option');
            option.value = key;
            option.text = lote.nome;
            select.appendChild(option);
        }
    }

    function destacarLote() {
        const selecionado = document.getElementById('loteSelect').value;
        // all lots display in green by default
        for (const key in poligonos) poligonos[key].setOptions({ fillColor: '#00FF00', strokeColor: '#00FF00' });
        if (selecionado && poligonos[selecionado]) {
            // highlight the selected lot in blue
            poligonos[selecionado].setOptions({ fillColor: '#0000FF', strokeColor: '#0000FF' });
            const bounds = new google.maps.LatLngBounds();
            lotes[selecionado].area.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds);
            mostrarInfoLote(selecionado);
        } else {
            document.getElementById('dadosLote').innerHTML = "Nenhum lote selecionado.";
        }
    }

    function mostrarInfoLote(key) {
        if (lotes[key]) {
            const descricaoFormatada = lotes[key].descricao.replace(/\n/g, "<br>");
            document.getElementById('dadosLote').innerHTML = `<strong>Nome:</strong> ${lotes[key].nome}<br><strong>Descrição:</strong><br>${descricaoFormatada}`;
        }
    }

    function adicionarOuAtualizarLote() {
        const nome = document.getElementById('nomeLote').value.trim();
        const descricao = document.getElementById('descricaoLote').value.trim();
        let area = [];
        const coordText = document.getElementById('coordenadas').value.trim();

        if (drawingMode && tempCoords.length > 0) {
            area = tempCoords;
            drawingMode = false;
            if (map) map.setOptions({ draggableCursor: null, draggingCursor: null });
            if (tempPolyline) tempPolyline.setMap(null);
            distanceOverlays.forEach(o => o.close());
            distanceOverlays = [];
            if (hoverInfo) hoverInfo.close();
            if (hoverLine) hoverLine.setMap(null);
            document.getElementById('cancelarDesenhoBtn').style.display = 'none';
        } else {
            const linhas = coordText.split('\n');
            for (const linha of linhas) {
                const partes = linha.split(',');
                const lat = parseFloat(partes[0]);
                const lng = parseFloat(partes[1]);
                if (!isNaN(lat) && !isNaN(lng)) area.push({ lat, lng });
            }
        }

        if (!nome || area.length < 3) {
            alert("Preencha o nome e uma área válida (mínimo 3 pontos). Ou use o modo de desenho.");
            return;
        }

        let key = loteEditando || "lote_" + Date.now();
        const metodo = loteEditando ? 'update' : 'add';
        loteEditando = null;

        lotes[key] = { nome, descricao, area };
        adicionarPoligonoAoMapa(key, lotes[key]);
        adicionarLoteAoDropdown(key, lotes[key]);

        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: metodo,
                id: key,
                nome: nome,
                descricao: descricao,
                coordenadas: JSON.stringify(area)
            })
        });

        limparFormulario();
        alert("Lote salvo com sucesso!");
    }

    function excluirLote() {
        const selecionado = document.getElementById('loteSelect').value;
        if (!selecionado || !lotes[selecionado]) {
            alert("Selecione um lote para excluir.");
            return;
        }
        if (poligonos[selecionado]) poligonos[selecionado].setMap(null);
        delete poligonos[selecionado];
        delete lotes[selecionado];
        document.querySelector(`#loteSelect option[value='${selecionado}']`).remove();
        document.getElementById('dadosLote').innerHTML = "Nenhum lote selecionado.";

        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'delete',
                id: selecionado
            })
        });
    }

    function editarLote() {
        const selecionado = document.getElementById('loteSelect').value;
        if (!selecionado || !lotes[selecionado]) {
            alert("Selecione um lote para editar.");
            return;
        }
        const lote = lotes[selecionado];
        document.getElementById('nomeLote').value = lote.nome;
        document.getElementById('descricaoLote').value = lote.descricao;
        document.getElementById('coordenadas').value = lote.area.map(p => `${p.lat},${p.lng}`).join('\n');
        loteEditando = selecionado;
        alert("Lote carregado para edição.");
    }

    function limparFormulario() {
        document.getElementById('nomeLote').value = "";
        document.getElementById('descricaoLote').value = "";
        document.getElementById('coordenadas').value = "";
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhEeVyf-afKNIFW414nQd9CEa-Luxx9sA&callback=initMap&libraries=geometry"></script>

</body>
</html>
