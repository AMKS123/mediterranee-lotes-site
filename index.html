<!-- MESMO HTML E CSS, só mudam as funções editar/excluir -->
<script>
  // ... Todo o resto igual (initMap, corPorStatus, etc.) ...

  function excluirLote() {
    const senha = prompt("Digite a senha para excluir o lote:");
    if (!senha) {
      alert("Senha obrigatória. Ação cancelada.");
      return;
    }

    const selecionado = document.getElementById('loteSelect').value;
    if (!selecionado || !lotes[selecionado]) {
      alert('Selecione um lote para excluir.');
      return;
    }

    if (poligonos[selecionado]) {
      poligonos[selecionado].polygon.setMap(null);
      if (poligonos[selecionado].labelMarker)
        poligonos[selecionado].labelMarker.setMap(null);
    }
    delete poligonos[selecionado];
    delete lotes[selecionado];
    document
      .querySelector(`#loteSelect option[value='${selecionado}']`)
      .remove();
    document.getElementById('dadosLote').innerHTML =
      'Nenhum lote selecionado.';

    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'delete',
        id: selecionado,
        password: senha
      })
    }).then(r => r.text()).then(r => {
      if (r.includes('Senha incorreta')) {
        alert(r);
      }
    });
  }

  function editarLote() {
    const senha = prompt("Digite a senha para editar o lote:");
    if (!senha) {
      alert("Senha obrigatória. Ação cancelada.");
      return;
    }

    const selecionado = document.getElementById('loteSelect').value;
    if (!selecionado || !lotes[selecionado]) {
      alert('Selecione um lote para editar.');
      return;
    }

    fetch(API_URL)
      .then(response => response.json())
      .then(data => {
        // Você pode criar aqui uma chamada que valide a senha no servidor se quiser
        // Neste caso só protege update no backend
      });

    const lote = lotes[selecionado];
    document.getElementById('nomeLote').value = lote.nome;
    document.getElementById('descricaoLote').value = lote.descricao;
    document.getElementById('loteamentoInput').value = lote.loteamento;
    document.getElementById('statusInput').value = lote.status || 'Disponível';
    document.getElementById('coordenadas').value = lote.area
      .map((p) => `${p.lat},${p.lng}`)
      .join('\n');
    loteEditando = selecionado;
    alert('Lote carregado para edição.');
  }

  function adicionarOuAtualizarLote() {
    const nome = document.getElementById('nomeLote').value.trim();
    const descricao = document.getElementById('descricaoLote').value.trim();
    const loteamento = document.getElementById('loteamentoInput').value.trim();
    const status = document.getElementById('statusInput').value;
    let area = [];
    const coordText = document.getElementById('coordenadas').value.trim();

    const linhas = coordText.split('\n');
    for (const linha of linhas) {
      const partes = linha.split(',');
      const lat = parseFloat(partes[0]);
      const lng = parseFloat(partes[1]);
      if (!isNaN(lat) && !isNaN(lng)) area.push({ lat, lng });
    }

    if (!nome || !loteamento || area.length < 3) {
      alert('Preencha o nome, loteamento e uma área válida (mínimo 3 pontos).');
      return;
    }

    let key = loteEditando || 'lote_' + Date.now();
    const metodo = loteEditando ? 'update' : 'add';
    let senha = '';

    if (metodo === 'update') {
      senha = prompt("Digite a senha para atualizar o lote:");
      if (!senha) {
        alert("Senha obrigatória. Ação cancelada.");
        return;
      }
    }

    loteEditando = null;

    lotes[key] = { nome, descricao, area, loteamento, status };
    todosLoteamentos.add(loteamento);
    adicionarPoligonoAoMapa(key, lotes[key]);
    popularLoteamentos();
    filtrarLotesPorLoteamento();
    adicionarLoteAoDropdown(key, lotes[key]);
    document.getElementById('loteamentoSelect').value = loteamento;

    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: metodo,
        id: key,
        nome: nome,
        descricao: descricao,
        loteamento: loteamento,
        status: status,
        coordenadas: JSON.stringify(area),
        password: senha
      })
    }).then(r => r.text()).then(r => {
      if (r.includes('Senha incorreta')) {
        alert(r);
      } else {
        limparFormulario();
        alert('Lote salvo com sucesso!');
      }
    });
  }
</script>
