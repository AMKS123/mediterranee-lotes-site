<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mediterranee Imobiliaria - Mapa de Lotes</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }
    #sidebar {
      width: 25%;
      padding: 20px;
      background-color: #f5f5f5;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }
    #map {
      width: 75%;
      height: 100%;
    }
    textarea, input, select, button {
      width: 100%;
      margin-bottom: 10px;
    }
    #infoLote {
      border: 1px solid #ccc;
      background-color: #fff;
      padding: 10px;
      margin-bottom: 10px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    button {
      padding: 8px;
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h1>Mediterranee Imobiliaria</h1>

    <label for="loteamentoSelect">Selecione um loteamento:</label>
    <select id="loteamentoSelect" onchange="filtrarLotesPorLoteamento()">
      <option value="">-- Escolha um loteamento --</option>
    </select>

    <label for="loteSelect">Selecione um lote:</label>
    <select id="loteSelect" onchange="destacarLote()">
      <option value="">-- Escolha um lote --</option>
    </select>
    <button onclick="excluirLote()">Excluir Lote Selecionado</button>
    <button onclick="editarLote()">Editar Lote Selecionado</button>

    <div id="infoLote">
      <h3>Descrição do lote:</h3>
      <div id="dadosLote">Nenhum lote selecionado.</div>
    </div>

    <h3>Cadastrar / Editar lote:</h3>
    <input type="text" id="nomeLote" placeholder="Nome do lote" />
    <input type="text" id="loteamentoInput" placeholder="Nome do loteamento" />
    <select id="statusInput">
      <option value="Disponível">Disponível</option>
      <option value="Reservado">Reservado</option>
      <option value="Vendido">Vendido</option>
    </select>
    <textarea id="descricaoLote" rows="3" placeholder="Descrição..."></textarea>
    <textarea id="coordenadas" rows="4" placeholder="Coordenadas lat,lon por linha..."></textarea>
    <input type="password" id="senhaInput" placeholder="Senha de alteração" />
    <button onclick="adicionarOuAtualizarLote(event)">Salvar Lote</button>
  </div>

  <div id="map"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzKTopaoS-nJI8xnLnAMiu6oESJ_y7rM_IEDbhL_XK8NGpM4GjVf9kI4Kl2QQNQHDzZ/exec';

    let map;
    const lotes = {};
    const poligonos = {};
    let loteEditando = null;
    let todosLoteamentos = new Set();

    function corPorStatus(status) {
      if (status === 'Disponível') return '#00cc44';
      if (status === 'Reservado') return '#ffcc00';
      if (status === 'Vendido') return '#ff4444';
      return '#0000FF';
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -20.899359547695433, lng: -46.99020733379837 },
        zoom: 18,
        mapTypeId: 'satellite'
      });

      fetch(API_URL)
        .then(r => r.json())
        .then(data => {
          todosLoteamentos.clear();
          data.forEach(lote => {
            try {
              lotes[lote.id] = {
                nome: lote.nome,
                descricao: lote.descricao,
                area: JSON.parse(lote.coordenadas),
                loteamento: lote.loteamento || '',
                status: lote.status || 'Disponível'
              };
              todosLoteamentos.add(lote.loteamento || '');
              adicionarPoligonoAoMapa(lote.id, lotes[lote.id]);
            } catch (e) {
              console.error('Erro ao processar lote:', lote, e);
            }
          });
          popularLoteamentos();
          filtrarLotesPorLoteamento();
        })
        .catch(err => console.error('Erro ao buscar lotes:', err));

      map.addListener('zoom_changed', () => {
        const zoom = map.getZoom();
        Object.values(poligonos).forEach(p => {
          if (p.labelMarker) p.labelMarker.setVisible(zoom >= 18);
        });
      });
    }

    function popularLoteamentos() {
      const sel = document.getElementById('loteamentoSelect');
      sel.innerHTML = '<option value="">-- Escolha um loteamento --</option>';
      Array.from(todosLoteamentos)
        .filter(l => l && l.trim())
        .sort()
        .forEach(l => {
          const opt = document.createElement('option');
          opt.value = l;
          opt.text = l;
          sel.appendChild(opt);
        });
    }

    function filtrarLotesPorLoteamento() {
      const loteamento = document.getElementById('loteamentoSelect').value;
      const sel = document.getElementById('loteSelect');
      sel.innerHTML = '<option value="">-- Escolha um lote --</option>';

      Object.entries(lotes).forEach(([id, lote]) => {
        if (lote.loteamento === loteamento) {
          const opt = document.createElement('option');
          opt.value = id;
          opt.text = lote.nome;
          sel.appendChild(opt);
        }
        poligonos[id].polygon.setOptions({
          fillColor: corPorStatus(lote.status),
          strokeColor: corPorStatus(lote.status)
        });
      });

      document.getElementById('dadosLote').innerText = 'Nenhum lote selecionado.';
    }

    function adicionarPoligonoAoMapa(id, lote) {
      // Remove polígono antigo, se existir
      if (poligonos[id]) {
        poligonos[id].polygon.setMap(null);
        poligonos[id].labelMarker.setMap(null);
      }

      const polygon = new google.maps.Polygon({
        paths: lote.area,
        strokeColor: corPorStatus(lote.status),
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: corPorStatus(lote.status),
        fillOpacity: 0.35,
        map
      });

      polygon.addListener('click', () => {
        document.getElementById('loteamentoSelect').value = lote.loteamento;
        filtrarLotesPorLoteamento();
        setTimeout(() => {
          const sel = document.getElementById('loteSelect');
          if (!sel.querySelector(`option[value="${id}"]`)) {
            const opt = document.createElement('option');
            opt.value = id;
            opt.text = lote.nome;
            sel.appendChild(opt);
          }
          sel.value = id;
          destacarLote();
        }, 0);
      });

      const bounds = new google.maps.LatLngBounds();
      lote.area.forEach(c => bounds.extend(c));
      const center = bounds.getCenter();

      const labelMarker = new google.maps.Marker({
        position: center,
        map,
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 },
        label: { text: lote.nome, color: '#000', fontSize: '10px', fontWeight: 'bold' }
      });

      poligonos[id] = { polygon, labelMarker };
    }

    function destacarLote() {
      const selected = document.getElementById('loteSelect').value;
      Object.entries(poligonos).forEach(([id, obj]) => {
        obj.polygon.setOptions({
          fillColor: corPorStatus(lotes[id].status),
          strokeColor: corPorStatus(lotes[id].status)
        });
      });

      if (selected && poligonos[selected]) {
        const obj = poligonos[selected];
        obj.polygon.setOptions({ fillColor: '#0000FF', strokeColor: '#0000FF' });
        const bounds = new google.maps.LatLngBounds();
        lotes[selected].area.forEach(c => bounds.extend(c));
        map.fitBounds(bounds);
        mostrarInfoLote(selected);
      } else {
        document.getElementById('dadosLote').innerText = 'Nenhum lote selecionado.';
      }
    }

    function mostrarInfoLote(id) {
      const lote = lotes[id];
      const desc = lote.descricao.replace(/\n/g, '<br>');
      document.getElementById('dadosLote').innerHTML =
        `<strong>Nome:</strong> ${lote.nome}<br>` +
        `<strong>Loteamento:</strong> ${lote.loteamento}<br>` +
        `<strong>Status:</strong> ${lote.status}<br>` +
        `<strong>Descrição:</strong><br>${desc}`;
    }

    // ————————— Funções de CRUD —————————

    function limparFormulario() {
      loteEditando = null;
      document.getElementById('nomeLote').value = '';
      document.getElementById('loteamentoInput').value = '';
      document.getElementById('statusInput').value = 'Disponível';
      document.getElementById('descricaoLote').value = '';
      document.getElementById('coordenadas').value = '';
      document.getElementById('senhaInput').value = '';
    }

    function editarLote() {
      const id = document.getElementById('loteSelect').value;
      if (!id) {
        alert('Primeiro escolha um lote para editar.');
        return;
      }
      const lote = lotes[id];
      loteEditando = id;
      document.getElementById('nomeLote').value        = lote.nome;
      document.getElementById('loteamentoInput').value = lote.loteamento;
      document.getElementById('statusInput').value     = lote.status;
      document.getElementById('descricaoLote').value   = lote.descricao;
      document.getElementById('coordenadas').value =
        lote.area.map(c => `${c.lat},${c.lng}`).join('\n');
    }

    function excluirLote() {
      const id = document.getElementById('loteSelect').value;
      if (!id) {
        alert('Primeiro escolha um lote para excluir.');
        return;
      }
      if (!confirm('Deseja mesmo excluir este lote?')) return;

      const senha = document.getElementById('senhaInput').value.trim();
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'delete', id, senha })
      })
      .then(r => r.json())
      .then(res => {
        alert(res.success ? res.message : res.error);
        if (res.success) {
          limparFormulario();
          location.reload();
        }
      })
      .catch(err => {
        console.error(err);
        alert('Erro ao excluir lote.');
      });
    }

    function adicionarOuAtualizarLote(event) {
      event.preventDefault();

      const nome       = document.getElementById('nomeLote').value.trim();
      const loteamento = document.getElementById('loteamentoInput').value.trim();
      const status     = document.getElementById('statusInput').value;
      const descricao  = document.getElementById('descricaoLote').value.trim();
      const rawCoords  = document.getElementById('coordenadas').value.trim();
      const senha      = document.getElementById('senhaInput').value.trim();

      if (!nome || !loteamento || !descricao || !rawCoords) {
        alert('Preencha todos os campos antes de salvar.');
        return;
      }

      const area = rawCoords
        .split('\n')
        .map(line => {
          const [lat, lng] = line.split(',').map(v => parseFloat(v.trim()));
          return { lat, lng };
        });

      const action = loteEditando ? 'update' : 'add';
      const id     = loteEditando || Date.now().toString();

      const payload = {
        action,
        id,
        nome,
        loteamento,
        status,
        descricao,
        coordenadas: JSON.stringify(area),
        senha
      };

      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(res => {
        alert(res.success ? res.message : res.error);
        if (res.success) {
          limparFormulario();
          location.reload();
        }
      })
      .catch(err => {
        console.error(err);
        alert('Erro ao salvar lote.');
      });
    }
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhEeVyf-afKNIFW414nQd9CEa-Luxx9sA&callback=initMap">
  </script>
</body>
</html>
